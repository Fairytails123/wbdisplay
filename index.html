<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairy Tails K9 Centre - TV Display Board</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ===================================================================
           FAIRY TAILS K9 CENTRE ‚Äî TV DISPLAY BOARD
           Designed for Bush 70" 4K QLED TV (3840√ó2160)
           Read-only display ‚Äî no writes to Google Sheets
           =================================================================== */

        :root {
            /* Brand */
            --brand: #00acee;
            --brand-dark: #007ba8;
            --brand-grad: linear-gradient(135deg, #00acee 0%, #007ba8 100%);

            /* Sections */
            --fd-accent: #00acee;
            --fd-grad: linear-gradient(135deg, #00acee, #007ba8);
            --fd-bg: #f0f7ff;
            --hd-accent: #f59e0b;
            --hd-grad: linear-gradient(135deg, #f59e0b, #d97706);
            --hd-bg: #fffbeb;
            --bd-accent: #8b5cf6;
            --bd-grad: linear-gradient(135deg, #8b5cf6, #7c3aed);
            --bd-bg: #f5f3ff;

            /* Van badges */
            --bv-bg: #dbeafe; --bv-text: #1d4ed8; --bv-bdr: #93c5fd;
            --sv-bg: #d1fae5; --sv-text: #065f46; --sv-bdr: #6ee7b7;
            --dv-bg: #fef3c7; --dv-text: #92400e; --dv-bdr: #fcd34d;
            --p-bg: #f3e8ff;  --p-text: #7c3aed;  --p-bdr: #c4b5fd;

            /* Status */
            --photo-done: #22c55e;
            --walk-booked-bg: #fef3c7; --walk-booked-text: #92400e;
            --walk-done-bg: #dcfce7;   --walk-done-text: #166534;
            --crate-bg: #fdf4ff; --crate-text: #86198f; --crate-bdr: #e879f9;

            /* Layout */
            --bg: #eef2f7;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.08);
            --radius: 0.45rem;

            /* Responsive root ‚Äî scales with viewport height for TV distance reading */
            font-size: clamp(16px, 2.05vh, 28px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        /* ======================== HEADER ======================== */
        .tv-header {
            background: var(--brand-grad);
            color: white;
            display: flex;
            align-items: center;
            padding: 0.35rem 0.8rem;
            gap: 0.8rem;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .hdr-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .hdr-logo {
            width: 2.2rem;
            height: 2.2rem;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.6);
        }

        .hdr-title {
            font-weight: 900;
            font-size: 1.05rem;
            letter-spacing: -0.02em;
            white-space: nowrap;
        }

        .hdr-date {
            font-size: 0.7rem;
            opacity: 0.85;
            font-weight: 600;
            white-space: nowrap;
        }

        .hdr-stats {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin-left: auto;
            flex-shrink: 0;
        }

        .hdr-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 700;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .hdr-stat .stat-emoji { font-size: 0.85rem; }
        .hdr-stat .stat-val {
            background: rgba(255,255,255,0.2);
            padding: 0.1rem 0.35rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 800;
        }

        .hdr-divider {
            width: 1px;
            height: 1.5rem;
            background: rgba(255,255,255,0.25);
            flex-shrink: 0;
        }

        .hdr-van-times {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0;
        }

        .van-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.6rem;
            font-weight: 800;
            padding: 0.12rem 0.35rem;
            border-radius: 0.2rem;
        }

        .van-chip.bv { background: var(--bv-bg); color: var(--bv-text); }
        .van-chip.sv { background: var(--sv-bg); color: var(--sv-text); }
        .van-chip.dv { background: var(--dv-bg); color: var(--dv-text); }

        .hdr-clock {
            font-size: 1.1rem;
            font-weight: 900;
            letter-spacing: 0.02em;
            font-variant-numeric: tabular-nums;
            flex-shrink: 0;
        }

        /* ======================== TABS ======================== */
        .tv-tabs {
            display: flex;
            align-items: center;
            background: white;
            padding: 0 0.5rem;
            flex-shrink: 0;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            padding: 0.4rem 1.2rem;
            font-size: 0.8rem;
            font-weight: 800;
            font-family: inherit;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s ease;
            outline: none;
            white-space: nowrap;
        }

        .tab-btn:hover, .tab-btn:focus-visible {
            color: var(--brand);
        }

        .tab-btn.active {
            color: var(--brand);
            border-bottom-color: var(--brand);
        }

        .tab-btn:focus-visible {
            box-shadow: 0 0 0 2px var(--brand), 0 0 0 4px rgba(0,172,238,0.3);
            border-radius: 0.25rem 0.25rem 0 0;
        }

        .tab-hint {
            margin-left: auto;
            font-size: 0.55rem;
            color: var(--text-muted);
            font-weight: 600;
            opacity: 0.6;
        }

        /* ======================== REFRESH BAR ======================== */
        .refresh-track {
            height: 3px;
            background: var(--border);
            flex-shrink: 0;
            overflow: hidden;
        }

        .refresh-fill {
            height: 100%;
            width: 0%;
            background: var(--brand-grad);
            transition: width 1s linear;
        }

        .refresh-fill.reset {
            transition: none;
        }

        /* ======================== BOARD LAYOUT ======================== */
        .tv-board {
            flex: 1;
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 0.4rem;
            padding: 0.4rem;
            min-height: 0;
        }

        .board-left {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .board-right {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            min-height: 0;
        }

        /* ======================== SECTIONS ======================== */
        .board-section {
            display: flex;
            flex-direction: column;
            background: var(--card);
            border-radius: var(--radius);
            overflow: hidden;
            min-height: 0;
            flex: 1;
            box-shadow: var(--shadow);
        }

        .section-hdr {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.3rem 0.6rem;
            font-weight: 800;
            font-size: 0.75rem;
            color: white;
            flex-shrink: 0;
        }

        .section-hdr.full-day { background: var(--fd-grad); }
        .section-hdr.half-day { background: var(--hd-grad); }
        .section-hdr.boarding { background: var(--bd-grad); }

        .section-hdr .s-label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .section-hdr .s-count {
            background: rgba(255,255,255,0.25);
            padding: 0.08rem 0.4rem;
            border-radius: 1rem;
            font-size: 0.6rem;
            font-weight: 800;
        }

        .cards-area {
            flex: 1;
            overflow-y: auto;
            padding: 0.3rem;
            display: flex;
            gap: 0.3rem;
            min-height: 0;
        }

        /* Hide scrollbar on TV */
        .cards-area::-webkit-scrollbar { width: 4px; }
        .cards-area::-webkit-scrollbar-track { background: transparent; }
        .cards-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .cards-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            min-width: 0;
        }

        /* ======================== DOG CARDS ======================== */
        .dog-card {
            background: var(--card);
            border-radius: 0.3rem;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .dog-card.fd-card { border-left: 4px solid var(--fd-accent); background: var(--fd-bg); }
        .dog-card.hd-card { border-left: 4px solid var(--hd-accent); background: var(--hd-bg); }
        .dog-card.bd-card { border-left: 4px solid var(--bd-accent); background: var(--bd-bg); }

        .card-main {
            display: flex;
            align-items: center;
            padding: 0.2rem 0.35rem;
            gap: 0.3rem;
            min-height: 1.8rem;
        }

        .card-name {
            font-weight: 800;
            font-size: 0.82rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .card-badges {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            flex-shrink: 0;
            flex-wrap: nowrap;
        }

        /* Badge groups (AM / PM) */
        .badge-grp {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.02rem;
        }

        .bg-label {
            font-size: 0.38rem;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            line-height: 1;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.08rem 0.28rem;
            border-radius: 0.2rem;
            font-size: 0.58rem;
            font-weight: 800;
            white-space: nowrap;
            line-height: 1.3;
            border: 1px solid transparent;
        }

        .badge-bv { background: var(--bv-bg); color: var(--bv-text); border-color: var(--bv-bdr); }
        .badge-sv { background: var(--sv-bg); color: var(--sv-text); border-color: var(--sv-bdr); }
        .badge-dv { background: var(--dv-bg); color: var(--dv-text); border-color: var(--dv-bdr); }
        .badge-p  { background: var(--p-bg);  color: var(--p-text);  border-color: var(--p-bdr);  }
        .badge-crate { background: var(--crate-bg); color: var(--crate-text); border-color: var(--crate-bdr); }

        .badge-empty {
            background: #f1f5f9;
            color: #94a3b8;
            font-size: 0.5rem;
            padding: 0.06rem 0.2rem;
        }

        /* Photo status */
        .photo-icon {
            font-size: 0.65rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .photo-icon.done { opacity: 1; }
        .photo-icon.pending { opacity: 0.25; filter: grayscale(1); }

        /* Walk badge */
        .walk-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.06rem 0.22rem;
            border-radius: 0.18rem;
            font-size: 0.55rem;
            font-weight: 800;
            white-space: nowrap;
        }

        .walk-booked { background: var(--walk-booked-bg); color: var(--walk-booked-text); }
        .walk-done   { background: var(--walk-done-bg);   color: var(--walk-done-text); }

        /* Card notes */
        .card-notes {
            padding: 0.12rem 0.35rem 0.22rem 0.55rem;
            font-size: 0.58rem;
            color: #475569;
            line-height: 1.35;
            border-top: 1px dashed var(--border);
            background: rgba(255,255,255,0.5);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .notes-icon {
            font-size: 0.5rem;
            margin-right: 0.15rem;
        }

        /* ======================== EMPTY STATE ======================== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--text-muted);
            opacity: 0.5;
            gap: 0.2rem;
            padding: 1rem;
        }

        .empty-icon { font-size: 1.8rem; }
        .empty-text { font-size: 0.65rem; font-weight: 700; }

        /* ======================== STATUS BAR ======================== */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.15rem 0.8rem;
            background: white;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            font-size: 0.5rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .conn-dot {
            width: 0.4rem;
            height: 0.4rem;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .conn-dot.ok { background: var(--photo-done); box-shadow: 0 0 4px rgba(34,197,94,0.5); }
        .conn-dot.error { background: #ef4444; box-shadow: 0 0 4px rgba(239,68,68,0.5); animation: pulse-dot 1.5s infinite; }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ======================== LOADING OVERLAY ======================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            gap: 0.8rem;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            object-fit: cover;
            animation: pulse-logo 1.5s ease-in-out infinite;
            box-shadow: 0 0 0 0 rgba(0,172,238,0.4);
        }

        @keyframes pulse-logo {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,172,238,0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(0,172,238,0); }
        }

        .loading-text {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--brand);
        }

        .loading-sub {
            font-size: 0.6rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* ======================== DATA-FLASH (new data indicator) ======================== */
        @keyframes flash-card {
            0% { background-color: rgba(0,172,238,0.15); }
            100% { background-color: transparent; }
        }

        .data-flash { animation: flash-card 0.8s ease-out; }

        /* ======================== RESPONSIVE (safety for non-4K) ======================== */
        @media (max-height: 600px) {
            :root { font-size: 14px; }
            .tv-header { padding: 0.25rem 0.6rem; }
            .section-hdr { padding: 0.2rem 0.5rem; }
        }

        @media (min-width: 3000px) {
            :root { font-size: clamp(20px, 1.5vh, 32px); }
        }
    </style>
</head>
<body>

    <!-- ============ HEADER ============ -->
    <header class="tv-header">
        <div class="hdr-brand">
            <img src="https://i.ibb.co/whdBKp0L/Logo-1.jpg" alt="Fairy Tails" class="hdr-logo">
            <div>
                <div class="hdr-title">Staff Board</div>
                <div class="hdr-date" id="dateDisplay">‚Äî</div>
            </div>
        </div>

        <div class="hdr-stats">
            <div class="hdr-stat">
                <span class="stat-emoji">üêï</span>
                <span class="stat-val" id="statDogs">0</span>
            </div>
            <div class="hdr-stat">
                <span class="stat-emoji">üì∏</span>
                <span class="stat-val" id="statPhotos">0</span>
            </div>
            <div class="hdr-stat">
                <span class="stat-emoji">üö∂</span>
                <span class="stat-val" id="statWalks">0</span>
            </div>
            <div class="hdr-stat">
                <span class="stat-emoji">üöê</span>
                <span class="stat-val" id="statVans">0</span>
            </div>

            <div class="hdr-divider"></div>

            <div class="hdr-van-times" id="vanTimesBar">
                <span class="van-chip bv">BV <span id="vtBV">‚Äî</span></span>
                <span class="van-chip dv">DV <span id="vtDV">‚Äî</span></span>
                <span class="van-chip sv">SV <span id="vtSV">‚Äî</span></span>
            </div>

            <div class="hdr-divider"></div>

            <div class="hdr-clock" id="clock">--:--:--</div>
        </div>
    </header>

    <!-- ============ TABS ============ -->
    <nav class="tv-tabs">
        <button class="tab-btn active" data-tab="today" tabindex="1" onclick="switchTab('today')">üìÖ TODAY</button>
        <button class="tab-btn" data-tab="tomorrow" tabindex="2" onclick="switchTab('tomorrow')">üìÜ TOMORROW</button>
        <span class="tab-hint">‚óÄ ‚ñ∂ Use remote arrows to switch</span>
    </nav>

    <!-- ============ REFRESH PROGRESS ============ -->
    <div class="refresh-track">
        <div class="refresh-fill" id="refreshFill"></div>
    </div>

    <!-- ============ MAIN BOARD ============ -->
    <main class="tv-board" id="tvBoard">
        <!-- Left: Full Day -->
        <div class="board-left">
            <div class="board-section" id="section-fd">
                <div class="section-hdr full-day">
                    <span class="s-label">‚òÄÔ∏è Full Day (Leave ~5pm)</span>
                    <span class="s-count" id="count-fd">0 dogs</span>
                </div>
                <div class="cards-area" id="cards-fd"></div>
            </div>
        </div>

        <!-- Right: Half Day + Boarding -->
        <div class="board-right">
            <div class="board-section" id="section-hd">
                <div class="section-hdr half-day">
                    <span class="s-label">üåÖ Half Day (Leave ~12pm)</span>
                    <span class="s-count" id="count-hd">0 dogs</span>
                </div>
                <div class="cards-area" id="cards-hd"></div>
            </div>
            <div class="board-section" id="section-bd">
                <div class="section-hdr boarding">
                    <span class="s-label">üè† Boarding</span>
                    <span class="s-count" id="count-bd">0 dogs</span>
                </div>
                <div class="cards-area" id="cards-bd"></div>
            </div>
        </div>
    </main>

    <!-- ============ STATUS BAR ============ -->
    <footer class="status-bar">
        <div class="status-left">
            <span class="conn-dot ok" id="connDot"></span>
            <span id="connText">Connected</span>
            <span>|</span>
            <span id="lastUpdate">Last refresh: ‚Äî</span>
        </div>
        <div>
            <span id="refreshCountdown"></span>
        </div>
    </footer>

    <!-- ============ LOADING OVERLAY ============ -->
    <div class="loading-overlay" id="loadingOverlay">
        <img src="https://i.ibb.co/whdBKp0L/Logo-1.jpg" alt="Loading" class="loading-logo">
        <div class="loading-text">Fairy Tails K9 Centre</div>
        <div class="loading-sub">Loading staff board‚Ä¶</div>
    </div>

    <script>
        // ================================================================
        //  CONFIGURATION
        // ================================================================
        const CONFIG = {
            // Same Google Apps Script URL as the edit board
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzqXD9OCM5oSNFdy3OF7pOG0PRcpy4dgkEYWJBVh40CFHJgjvSpPn6SE-mNjloo-GKw/exec',

            // 97 seconds ‚Äî offset from edit board's 93s inbound & 94s outbound
            REFRESH_INTERVAL: 97000,

            // Retry interval on connection failure
            RETRY_INTERVAL: 15000,

            // Clock tick
            CLOCK_INTERVAL: 1000
        };

        // Allow URL parameter overrides: ?scale=1.2 or ?refresh=60
        const urlParams = new URLSearchParams(window.location.search);
        const userScale = parseFloat(urlParams.get('scale')) || 1;
        if (userScale !== 1) {
            document.documentElement.style.fontSize =
                `calc(clamp(16px, 2.05vh, 28px) * ${userScale})`;
        }
        const customRefresh = parseInt(urlParams.get('refresh'));
        if (customRefresh && customRefresh >= 10) {
            CONFIG.REFRESH_INTERVAL = customRefresh * 1000;
        }

        // ================================================================
        //  STATE
        // ================================================================
        let state = {
            tab: 'today',
            data: null,
            lastUpdate: null,
            loading: true,
            error: false,
            firstLoad: true
        };

        // ================================================================
        //  DATA FETCHING (READ-ONLY ‚Äî no writes, no impact on automation)
        // ================================================================
        async function fetchData() {
            try {
                const resp = await fetch(CONFIG.SCRIPT_URL + '?action=load', {
                    method: 'GET',
                    redirect: 'follow'
                });

                if (!resp.ok) throw new Error('HTTP ' + resp.status);

                const result = await resp.json();

                if (result.success && result.data) {
                    state.data = result.data;
                    state.lastUpdate = new Date();
                    state.error = false;
                } else {
                    throw new Error(result.error || 'Invalid response');
                }
            } catch (err) {
                console.error('Fetch error:', err);
                state.error = true;

                // If first load fails, retry sooner
                if (state.firstLoad) {
                    setTimeout(fetchData, CONFIG.RETRY_INTERVAL);
                }
            } finally {
                state.loading = false;
                render();

                if (state.firstLoad && !state.error) {
                    state.firstLoad = false;
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').classList.add('hidden');
                    }, 400);
                }
            }
        }

        // ================================================================
        //  RENDERING
        // ================================================================
        function render() {
            const tabData = state.data?.[state.tab];
            if (!tabData) return;

            renderStats(tabData);
            renderVanTimes(tabData.vanTimes);
            renderAllSections(tabData.dogs || []);
            renderStatusBar();
        }

        // ---- Stats ----
        function renderStats(tabData) {
            const dogs = tabData.dogs || [];
            const vanTypes = ['V', 'BV', 'SV', 'DV'];

            const total = dogs.length;
            const photos = dogs.filter(d => d.photo).length;
            const walks = dogs.filter(d => d.walk === 'booked' || d.walk === 'transferred').length;
            const vans = dogs.filter(d => vanTypes.includes(d.vpAM) || vanTypes.includes(d.vpPM)).length;

            document.getElementById('statDogs').textContent = total;
            document.getElementById('statPhotos').textContent = `${photos}/${total}`;
            document.getElementById('statWalks').textContent = walks;
            document.getElementById('statVans').textContent = vans;
        }

        // ---- Van Times ----
        function renderVanTimes(vt) {
            if (!vt) return;
            document.getElementById('vtBV').textContent = vt.BV || '‚Äî';
            document.getElementById('vtDV').textContent = vt.DV || '‚Äî';
            document.getElementById('vtSV').textContent = vt.SV || '‚Äî';
        }

        // ---- Board Sections ----
        function renderAllSections(dogs) {
            const groups = { 'Full Day': [], 'Half Day AM': [], 'Boarding': [] };

            dogs.forEach(d => {
                const t = (d.serviceType || 'Full Day');
                if (t.includes('Half Day'))       groups['Half Day AM'].push(d);
                else if (t.includes('Boarding'))   groups['Boarding'].push(d);
                else                               groups['Full Day'].push(d);
            });

            renderSection('fd', groups['Full Day'],    'fd');
            renderSection('hd', groups['Half Day AM'], 'hd');
            renderSection('bd', groups['Boarding'],    'bd');
        }

        function renderSection(id, dogs, type) {
            const container = document.getElementById('cards-' + id);
            const countEl   = document.getElementById('count-' + id);

            const label = dogs.length === 1 ? '1 dog' : dogs.length + ' dogs';
            countEl.textContent = label;

            if (dogs.length === 0) {
                container.innerHTML =
                    '<div class="empty-state"><div class="empty-icon">üêæ</div><div class="empty-text">No dogs</div></div>';
                return;
            }

            // Calculate column count based on available container height
            const cols = calcColumns(dogs, container);
            const distributed = distributeColumns(dogs, cols);

            container.innerHTML = distributed.map(colDogs =>
                '<div class="cards-col">' +
                colDogs.map(d => renderCard(d, type)).join('') +
                '</div>'
            ).join('');
        }

        function calcColumns(dogs, container) {
            // Estimate available height (use offsetHeight or fallback)
            const h = container.offsetHeight || 500;

            // Approximate per-card height: base ~38px, notes add ~22px per notes line (~60 chars)
            let totalH = 0;
            dogs.forEach(d => {
                let cardH = 38;
                if (d.notes) {
                    const lines = Math.ceil(d.notes.length / 55) || 1;
                    cardH += 16 + (lines * 15);
                }
                totalH += cardH;
            });

            const needed = Math.ceil(totalH / Math.max(h, 200));
            return Math.max(1, Math.min(5, needed));
        }

        function distributeColumns(dogs, n) {
            if (n <= 1) return [dogs];

            // Balanced distribution ‚Äî estimate height for each dog and balance across columns
            const heights = dogs.map(d => {
                let h = 38;
                if (d.notes) {
                    const lines = Math.ceil(d.notes.length / 55) || 1;
                    h += 16 + (lines * 15);
                }
                return h;
            });

            // Greedy assignment: put each dog in the shortest column
            const cols = Array.from({ length: n }, () => ({ dogs: [], height: 0 }));
            dogs.forEach((dog, i) => {
                const shortest = cols.reduce((min, c) => c.height < min.height ? c : min, cols[0]);
                shortest.dogs.push(dog);
                shortest.height += heights[i];
            });

            return cols.map(c => c.dogs);
        }

        // ---- Card HTML ----
        function renderCard(dog, type) {
            const isBoarding = type === 'bd';

            // AM badge
            const amBadge = vpBadgeHTML(dog.vpAM, dog.stopAM);
            // PM badge (not for boarding)
            const pmBadge = !isBoarding ? vpBadgeHTML(dog.vpPM, dog.stop) : '';
            // Crate badge (boarding only)
            const crateBadge = isBoarding && dog.crate
                ? `<span class="badge badge-crate">${esc(dog.crate)}</span>`
                : '';
            // Photo
            const photoHTML = dog.photo
                ? '<span class="photo-icon done">üì∏</span>'
                : '<span class="photo-icon pending">üì∑</span>';
            // Walk
            const walkHTML = walkBadgeHTML(dog.walk);
            // Notes
            const notesHTML = dog.notes
                ? `<div class="card-notes"><span class="notes-icon">üìù</span>${esc(dog.notes)}</div>`
                : '';

            const cardClass = type === 'fd' ? 'fd-card' : type === 'hd' ? 'hd-card' : 'bd-card';

            // Build AM/PM badge groups
            let badgeGroupsHTML = '';
            if (amBadge || (!isBoarding && pmBadge)) {
                if (amBadge) {
                    badgeGroupsHTML += `<div class="badge-grp"><span class="bg-label">AM</span>${amBadge}</div>`;
                }
                if (!isBoarding && pmBadge) {
                    badgeGroupsHTML += `<div class="badge-grp"><span class="bg-label">PM</span>${pmBadge}</div>`;
                }
                // Show dashes for unassigned slots
                if (!amBadge) {
                    badgeGroupsHTML = `<div class="badge-grp"><span class="bg-label">AM</span><span class="badge badge-empty">‚Äì</span></div>` + badgeGroupsHTML;
                }
                if (!isBoarding && !pmBadge) {
                    badgeGroupsHTML += `<div class="badge-grp"><span class="bg-label">PM</span><span class="badge badge-empty">‚Äì</span></div>`;
                }
            }

            return `<div class="dog-card ${cardClass}">` +
                '<div class="card-main">' +
                    `<span class="card-name">${esc(dog.name)}</span>` +
                    '<div class="card-badges">' +
                        badgeGroupsHTML +
                        crateBadge +
                        photoHTML +
                        walkHTML +
                    '</div>' +
                '</div>' +
                notesHTML +
            '</div>';
        }

        function vpBadgeHTML(vp, stop) {
            if (!vp) return '';
            const cls = vpClass(vp);
            const text = stop ? (vp + stop) : vp;
            return `<span class="badge ${cls}">${esc(text)}</span>`;
        }

        function vpClass(vp) {
            if (vp === 'V' || vp === 'BV') return 'badge-bv';
            if (vp === 'SV') return 'badge-sv';
            if (vp === 'DV') return 'badge-dv';
            if (vp === 'P')  return 'badge-p';
            return '';
        }

        function walkBadgeHTML(walk) {
            if (walk === 'booked')     return '<span class="walk-badge walk-booked">üö∂</span>';
            if (walk === 'transferred') return '<span class="walk-badge walk-done">üö∂‚úÖ</span>';
            return '';
        }

        // ---- Status Bar ----
        function renderStatusBar() {
            const dot  = document.getElementById('connDot');
            const text = document.getElementById('connText');
            const upd  = document.getElementById('lastUpdate');

            dot.className  = 'conn-dot ' + (state.error ? 'error' : 'ok');
            text.textContent = state.error ? 'Connection lost ‚Äî retrying‚Ä¶' : 'Connected';
            upd.textContent  = state.lastUpdate
                ? 'Last refresh: ' + state.lastUpdate.toLocaleTimeString('en-GB')
                : 'Last refresh: ‚Äî';
        }

        // ================================================================
        //  TAB SWITCHING
        // ================================================================
        function switchTab(tab) {
            state.tab = tab;
            document.querySelectorAll('.tab-btn').forEach(b =>
                b.classList.toggle('active', b.dataset.tab === tab)
            );
            render();
        }

        // ================================================================
        //  KEYBOARD / TV REMOTE NAVIGATION
        // ================================================================
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                e.preventDefault();
                switchTab(state.tab === 'today' ? 'tomorrow' : 'today');
            }
        });

        // ================================================================
        //  CLOCK
        // ================================================================
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent =
                now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            document.getElementById('dateDisplay').textContent =
                now.toLocaleDateString('en-GB', {
                    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                });
        }

        // ================================================================
        //  AUTO-REFRESH WITH PROGRESS BAR
        // ================================================================
        let refreshTimer = null;
        let progressTimer = null;
        let progressMs = 0;

        function startAutoRefresh() {
            progressMs = 0;

            refreshTimer = setInterval(async () => {
                // Reset progress
                const fill = document.getElementById('refreshFill');
                fill.classList.add('reset');
                fill.style.width = '0%';

                // Force reflow so the reset takes effect instantly
                void fill.offsetWidth;
                fill.classList.remove('reset');
                progressMs = 0;

                await fetchData();
            }, CONFIG.REFRESH_INTERVAL);

            progressTimer = setInterval(() => {
                progressMs += 1000;
                const pct = Math.min(100, (progressMs / CONFIG.REFRESH_INTERVAL) * 100);
                document.getElementById('refreshFill').style.width = pct + '%';

                // Update countdown
                const remaining = Math.max(0, Math.round((CONFIG.REFRESH_INTERVAL - progressMs) / 1000));
                document.getElementById('refreshCountdown').textContent =
                    'Next refresh in ' + remaining + 's';
            }, 1000);
        }

        // ================================================================
        //  ESCAPE HTML UTILITY
        // ================================================================
        const escDiv = document.createElement('div');
        function esc(str) {
            if (!str) return '';
            escDiv.textContent = str;
            return escDiv.innerHTML;
        }

        // ================================================================
        //  INITIALISATION
        // ================================================================
        async function init() {
            updateClock();
            setInterval(updateClock, CONFIG.CLOCK_INTERVAL);

            await fetchData();
            startAutoRefresh();
        }

        init();
    </script>
</body>
</html>
